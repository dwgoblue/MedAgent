#!/usr/bin/env bash
#SBATCH --job-name=medagent
#SBATCH --output=log/medagent_%j.out
#SBATCH --error=log/medagent_%j.err
#SBATCH --time=08:00:00
#SBATCH --cpus-per-task=8
#SBATCH --mem=40G
#SBATCH --partition=gpuq
#SBATCH --qos=bio_ai
#SBATCH --gres=gpu:h100:1

set -euo pipefail

export OMP_NUM_THREADS=${OMP_NUM_THREADS:-${SLURM_CPUS_PER_TASK:-8}}
export MKL_NUM_THREADS=${MKL_NUM_THREADS:-$OMP_NUM_THREADS}
export OPENBLAS_NUM_THREADS=${OPENBLAS_NUM_THREADS:-$OMP_NUM_THREADS}
export NUMEXPR_NUM_THREADS=${NUMEXPR_NUM_THREADS:-$OMP_NUM_THREADS}
export TORCH_NUM_THREADS=${TORCH_NUM_THREADS:-$OMP_NUM_THREADS}

MODE="v1"         # v1 | v2
CPB_PATH="medagent_system/runtime/examples/sample_cpb.json"
OUT_ROOT="medagent_system/runtime/examples/cluster_runs"
ENV_NAME="synthlab"
USE_MEDGEMMA=""
MEDGEMMA_MODEL_ID=""
MEDGEMMA_MODEL_DIR=""
HF_HOME_OVERRIDE=""
MEDGEMMA_LOCAL_ONLY=""
MEDGEMMA_DEVICE=""
MEDGEMMA_DTYPE=""
USE_OPENAI=""
OPENAI_MODEL=""
OPENAI_API_KEY_ARG=""
USE_BIOMCP_SDK=""
ENABLE_CRITIC=""
MAX_SUPERVISOR_REVISIONS=""
MAX_CRITIC_CYCLES=""
MEDGEMMA_USE_IMAGE_TENSORS=""
SYNTHLAB_MAX_PATIENTS=""
SYNTHLAB_MODALITIES=""
SYNTHLAB_DOWNLOAD_IF_MISSING=""

usage() {
  cat <<'EOF'
Usage:
  sbatch medagent_system/runtime/run_medagent.sbat [v1|v2]
  sbatch medagent_system/runtime/run_medagent.sbat [v1|v2] <cpb_path> <out_root> <env_name>
  sbatch medagent_system/runtime/run_medagent.sbat --mode v2 [options]

Options:
  --mode v1|v2
  --cpb <path>
  --out-root <path>
  --env <conda_env_name>
  --use-medgemma 0|1
  --medgemma-model-id <hf_repo_id>
  --medgemma-model-dir <local_model_path>
  --hf-home <hf_cache_root>
  --medgemma-local-only 0|1
  --medgemma-device auto|cuda|cpu
  --medgemma-dtype auto|bfloat16|float16|float32
  --use-openai 0|1
  --openai-model <model_name>
  --openai-api-key <key>
  --use-biomcp-sdk 0|1
  --enable-critic 0|1
  --max-supervisor-revisions <int>
  --max-critic-cycles <int>
  --use-medgemma-image-tensors 0|1
  --synthlab-max-patients <int>
  --synthlab-modalities <csv>
  --synthlab-download-if-missing 0|1
  -h|--help
EOF
}

# Backward-compatible positional parsing.
if [[ "${1:-}" == "v1" || "${1:-}" == "v2" || "${1:-}" == "mvp" ]]; then
  MODE="${1}"
  CPB_PATH="${2:-$CPB_PATH}"
  OUT_ROOT="${3:-$OUT_ROOT}"
  ENV_NAME="${4:-$ENV_NAME}"
  shift $(( $# > 4 ? 4 : $# ))
fi

while [[ $# -gt 0 ]]; do
  case "$1" in
    --mode) MODE="${2:?missing value for --mode}"; shift 2 ;;
    --cpb) CPB_PATH="${2:?missing value for --cpb}"; shift 2 ;;
    --out-root) OUT_ROOT="${2:?missing value for --out-root}"; shift 2 ;;
    --env) ENV_NAME="${2:?missing value for --env}"; shift 2 ;;
    --use-medgemma) USE_MEDGEMMA="${2:?missing value for --use-medgemma}"; shift 2 ;;
    --medgemma-model-id) MEDGEMMA_MODEL_ID="${2:?missing value for --medgemma-model-id}"; shift 2 ;;
    --medgemma-model-dir) MEDGEMMA_MODEL_DIR="${2:?missing value for --medgemma-model-dir}"; shift 2 ;;
    --hf-home) HF_HOME_OVERRIDE="${2:?missing value for --hf-home}"; shift 2 ;;
    --medgemma-local-only) MEDGEMMA_LOCAL_ONLY="${2:?missing value for --medgemma-local-only}"; shift 2 ;;
    --medgemma-device) MEDGEMMA_DEVICE="${2:?missing value for --medgemma-device}"; shift 2 ;;
    --medgemma-dtype) MEDGEMMA_DTYPE="${2:?missing value for --medgemma-dtype}"; shift 2 ;;
    --use-openai) USE_OPENAI="${2:?missing value for --use-openai}"; shift 2 ;;
    --openai-model) OPENAI_MODEL="${2:?missing value for --openai-model}"; shift 2 ;;
    --openai-api-key) OPENAI_API_KEY_ARG="${2:?missing value for --openai-api-key}"; shift 2 ;;
    --use-biomcp-sdk) USE_BIOMCP_SDK="${2:?missing value for --use-biomcp-sdk}"; shift 2 ;;
    --enable-critic) ENABLE_CRITIC="${2:?missing value for --enable-critic}"; shift 2 ;;
    --max-supervisor-revisions) MAX_SUPERVISOR_REVISIONS="${2:?missing value for --max-supervisor-revisions}"; shift 2 ;;
    --max-critic-cycles) MAX_CRITIC_CYCLES="${2:?missing value for --max-critic-cycles}"; shift 2 ;;
    --use-medgemma-image-tensors) MEDGEMMA_USE_IMAGE_TENSORS="${2:?missing value for --use-medgemma-image-tensors}"; shift 2 ;;
    --synthlab-max-patients) SYNTHLAB_MAX_PATIENTS="${2:?missing value for --synthlab-max-patients}"; shift 2 ;;
    --synthlab-modalities) SYNTHLAB_MODALITIES="${2:?missing value for --synthlab-modalities}"; shift 2 ;;
    --synthlab-download-if-missing) SYNTHLAB_DOWNLOAD_IF_MISSING="${2:?missing value for --synthlab-download-if-missing}"; shift 2 ;;
    -h|--help) usage; exit 0 ;;
    *) echo "Unknown argument: $1" >&2; usage; exit 2 ;;
  esac
done

if [[ "$MODE" == "v1" || "$MODE" == "mvp" ]]; then
  PIPELINE_MODE="mvp"
elif [[ "$MODE" == "v2" ]]; then
  PIPELINE_MODE="v2"
else
  echo "Unsupported mode: $MODE (use v1 or v2)" >&2
  exit 2
fi

# Try to activate conda env when available.
# Load user shell exports (e.g., OPENAI_API_KEY in ~/.bashrc) when present.
if [[ -f "$HOME/.bashrc" ]]; then
  set +u
  # shellcheck disable=SC1090
  source "$HOME/.bashrc"
  set -u
fi

if command -v conda >/dev/null 2>&1; then
  CONDA_BASE="$(conda info --base)"
  # shellcheck disable=SC1091
  source "$CONDA_BASE/etc/profile.d/conda.sh"
  conda activate "$ENV_NAME"
fi

TS="$(date +%Y%m%d_%H%M%S)"
JOB_TAG="${SLURM_JOB_ID:-local}_${PIPELINE_MODE}_${TS}"
RUN_DIR="$OUT_ROOT/$JOB_TAG"
LOG_DIR="$RUN_DIR/logs"
mkdir -p "$RUN_DIR" "$LOG_DIR"

cd "${SLURM_SUBMIT_DIR:-$PWD}"
export PYTHONPATH=.
export MEDAGENT_PIPELINE_MODE="$PIPELINE_MODE"
export MEDAGENT_RUN_LOG_DIR="$LOG_DIR"

if [[ -n "$USE_MEDGEMMA" ]]; then export MEDAGENT_USE_MEDGEMMA="$USE_MEDGEMMA"; fi
if [[ -n "$MEDGEMMA_MODEL_ID" ]]; then export MEDAGENT_MEDGEMMA_MODEL_ID="$MEDGEMMA_MODEL_ID"; fi
if [[ -n "$MEDGEMMA_MODEL_DIR" ]]; then export MEDAGENT_MEDGEMMA_MODEL_DIR="$MEDGEMMA_MODEL_DIR"; fi
if [[ -n "$HF_HOME_OVERRIDE" ]]; then export HF_HOME="$HF_HOME_OVERRIDE"; fi
if [[ -n "$MEDGEMMA_LOCAL_ONLY" ]]; then export MEDAGENT_MEDGEMMA_LOCAL_ONLY="$MEDGEMMA_LOCAL_ONLY"; fi
if [[ -n "$MEDGEMMA_DEVICE" ]]; then export MEDAGENT_MEDGEMMA_DEVICE="$MEDGEMMA_DEVICE"; fi
if [[ -n "$MEDGEMMA_DTYPE" ]]; then export MEDAGENT_MEDGEMMA_DTYPE="$MEDGEMMA_DTYPE"; fi
if [[ -n "$USE_OPENAI" ]]; then export MEDAGENT_USE_OPENAI="$USE_OPENAI"; fi
if [[ -n "$OPENAI_MODEL" ]]; then export MEDAGENT_OPENAI_MODEL="$OPENAI_MODEL"; fi
if [[ -n "$OPENAI_API_KEY_ARG" ]]; then export OPENAI_API_KEY="$OPENAI_API_KEY_ARG"; fi
if [[ -n "$USE_BIOMCP_SDK" ]]; then export MEDAGENT_USE_BIOMCP_SDK="$USE_BIOMCP_SDK"; fi
if [[ -n "$ENABLE_CRITIC" ]]; then export MEDAGENT_V2_ENABLE_CRITIC="$ENABLE_CRITIC"; fi
if [[ -n "$MAX_SUPERVISOR_REVISIONS" ]]; then export MEDAGENT_V2_MAX_SUPERVISOR_REVISIONS="$MAX_SUPERVISOR_REVISIONS"; fi
if [[ -n "$MAX_CRITIC_CYCLES" ]]; then export MEDAGENT_V2_MAX_CRITIC_CYCLES="$MAX_CRITIC_CYCLES"; fi
if [[ -n "$MEDGEMMA_USE_IMAGE_TENSORS" ]]; then export MEDAGENT_MEDGEMMA_USE_IMAGE_TENSORS="$MEDGEMMA_USE_IMAGE_TENSORS"; fi

# Optional OpenAI usage:
# export MEDAGENT_USE_OPENAI=1
# export OPENAI_API_KEY=...

OUTPUT_JSON="$RUN_DIR/final_output.json"

echo "[medagent] mode=$PIPELINE_MODE cpb=$CPB_PATH run_dir=$RUN_DIR"
if [[ -n "$SYNTHLAB_MAX_PATIENTS" && "$SYNTHLAB_MAX_PATIENTS" -gt 0 ]]; then
  SYN_OUT="$RUN_DIR/synthlab_output.json"
  MODS="${SYNTHLAB_MODALITIES:-fhir,genomics,notes,dicom}"
  EXTRA=()
  if [[ "${SYNTHLAB_DOWNLOAD_IF_MISSING:-0}" == "1" ]]; then
    EXTRA+=(--download-if-missing)
  fi
  python3 medagent_system/runtime/harness/synthlab_runner.py \
    --max-patients "$SYNTHLAB_MAX_PATIENTS" \
    --modalities "$MODS" \
    --output "$SYN_OUT" \
    "${EXTRA[@]}"
  OUTPUT_JSON="$SYN_OUT"
else
  python3 medagent_system/runtime/run_mvp.py --cpb "$CPB_PATH" --output "$OUTPUT_JSON"
fi

echo "[medagent] done"
echo "- final output: $OUTPUT_JSON"
echo "- agent outputs log: $LOG_DIR/agent_outputs.jsonl"
echo "- agent communications log: $LOG_DIR/agent_comms.jsonl"
